<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Funnel Tracker - Config Builder</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }
        
        .main-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            margin: 2rem auto;
            padding: 2rem;
            max-width: 1200px;
        }
        
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-bottom: 1.5rem;
        }
        
        .card-header {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            color: white;
            border-radius: 15px 15px 0 0 !important;
            border: none;
            padding: 1rem 1.5rem;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            border: none;
            border-radius: 10px;
            padding: 12px 24px;
            font-weight: 600;
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #6b7280, #4b5563);
            border: none;
            border-radius: 10px;
            padding: 12px 24px;
            font-weight: 600;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #10b981, #059669);
            border: none;
            border-radius: 10px;
            padding: 12px 24px;
            font-weight: 600;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            border: none;
            border-radius: 10px;
            padding: 8px 16px;
            font-weight: 600;
        }
        
        .form-control, .form-select, .form-textarea {
            border-radius: 10px;
            border: 2px solid #e2e8f0;
            padding: 12px 16px;
        }
        
        .form-control:focus, .form-select:focus, .form-textarea:focus {
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        .alert {
            border-radius: 10px;
            border: none;
            padding: 1rem 1.5rem;
        }
        
        .alert-success {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }
        
        .alert-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }
        
        .step-card {
            border: 2px solid #e2e8f0;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            background: #f8fafc;
            position: relative;
        }
        
        .step-card:hover {
            border-color: #2563eb;
            background: rgba(37, 99, 235, 0.05);
        }
        
        .step-number {
            position: absolute;
            top: -10px;
            left: 20px;
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
        }
        
        .nav-tabs .nav-link {
            border: none;
            border-radius: 10px 10px 0 0;
            color: #64748b;
            font-weight: 500;
            padding: 12px 20px;
            margin-right: 5px;
        }
        
        .nav-tabs .nav-link.active {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            color: white;
            border: none;
        }
        
        .nav-tabs .nav-link:hover:not(.active) {
            background: rgba(37, 99, 235, 0.1);
            color: #2563eb;
            border: none;
        }
        
        .tab-content {
            background: #f8fafc;
            border-radius: 0 0 15px 15px;
            padding: 1.5rem;
            border: 2px solid #e2e8f0;
            border-top: none;
        }
        
        .loading {
            display: none;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #2563eb;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .form-section {
            margin-bottom: 2rem;
        }
        
        .form-section h5 {
            color: #1e293b;
            margin-bottom: 1rem;
            font-weight: 600;
        }
        
        .help-text {
            font-size: 0.875rem;
            color: #64748b;
            margin-top: 0.25rem;
        }
        
        .required {
            color: #ef4444;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="main-container">
            <!-- Header -->
            <div class="text-center mb-4">
                <h1 class="display-5 fw-bold text-primary mb-3">
                    <i class="fas fa-cogs me-3"></i>
                    Funnel Config Builder
                </h1>
                <p class="lead text-secondary">Create your funnel configuration step by step</p>
                <div class="mt-3">
                    <a href="{{ url_for('index') }}" class="btn btn-secondary me-2">
                        <i class="fas fa-upload me-2"></i>
                        Upload Config Instead
                    </a>
                </div>
            </div>

            <!-- Flash Messages -->
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                            <i class="fas fa-{{ 'exclamation-triangle' if category == 'error' else 'check-circle' }} me-2"></i>
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}

            <!-- Config Builder Form -->
            <form action="{{ url_for('create_config') }}" method="post" onsubmit="return validateForm()">
                <input type="hidden" name="auth_method" id="auth_method" value="sso">
                <input type="hidden" name="step_count" id="step_count" value="0">
                
                <!-- Basic Configuration -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-info-circle me-2"></i>
                            Basic Configuration
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label">Funnel Name <span class="required">*</span></label>
                                <input type="text" class="form-control" name="funnel_name" placeholder="e.g., ecommerce_checkout_funnel" required>
                                <div class="help-text">A unique name for your funnel analysis</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Time Period (Days) <span class="required">*</span></label>
                                <input type="number" class="form-control" name="time_period_days" value="30" min="1" max="365" required>
                                <div class="help-text">How many days of data to analyze</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- BigQuery Configuration -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-database me-2"></i>
                            BigQuery Configuration
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label">Project ID <span class="required">*</span></label>
                                <input type="text" class="form-control" name="project_id" placeholder="your-project-id" required>
                                <div class="help-text">Your Google Cloud project ID</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Source Dataset <span class="required">*</span></label>
                                <input type="text" class="form-control" name="source_dataset" placeholder="events" required>
                                <div class="help-text">Dataset containing your event data</div>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <label class="form-label">Table Name <span class="required">*</span></label>
                                <input type="text" class="form-control" name="table_name" placeholder="events" required>
                                <div class="help-text">Table containing your event data</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Destination Dataset <span class="required">*</span></label>
                                <input type="text" class="form-control" name="destination_dataset" placeholder="sandbox" required>
                                <div class="help-text">Dataset where results will be stored</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Column Mapping -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-columns me-2"></i>
                            Column Mapping
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label">User ID Column <span class="required">*</span></label>
                                <input type="text" class="form-control" name="user_id_column" placeholder="user_id" required>
                                <div class="help-text">Column containing unique user identifiers</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Session ID Column <span class="required">*</span></label>
                                <input type="text" class="form-control" name="session_id_column" placeholder="anonymous_id" required>
                                <div class="help-text">Column containing session identifiers</div>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <label class="form-label">Event Column <span class="required">*</span></label>
                                <input type="text" class="form-control" name="event_column" placeholder="event" required>
                                <div class="help-text">Column containing event names</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Timestamp Column <span class="required">*</span></label>
                                <input type="text" class="form-control" name="timestamp_column" placeholder="timestamp" required>
                                <div class="help-text">Column containing event timestamps</div>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <label class="form-label">Partition Column</label>
                                <input type="text" class="form-control" name="partition_column" placeholder="date">
                                <div class="help-text">Optional: Column used for partitioning (e.g., date)</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Funnel Steps -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-route me-2"></i>
                            Funnel Steps
                        </h5>
                        <button type="button" class="btn btn-success btn-sm" onclick="addStep()">
                            <i class="fas fa-plus me-1"></i>
                            Add Step
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="steps-container">
                            <!-- Steps will be added here dynamically -->
                        </div>
                        <div class="text-center mt-3" id="no-steps-message">
                            <p class="text-muted">No steps added yet. Click "Add Step" to get started.</p>
                        </div>
                    </div>
                </div>

                <!-- Advanced Options -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-cog me-2"></i>
                            Advanced Options
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label">User Base Table</label>
                                <input type="text" class="form-control" name="user_base_table" placeholder="users.user_profiles">
                                <div class="help-text">Optional: Table with additional user data for segmentation</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">User Segmentation Fields</label>
                                <input type="text" class="form-control" name="user_segmentation_fields" placeholder="age_group,country,plan_type">
                                <div class="help-text">Comma-separated list of fields for user segmentation</div>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-4">
                                <label class="form-label">App Version Extraction</label>
                                <input type="text" class="form-control" name="app_version_extraction" placeholder="app">
                                <div class="help-text">Field to extract app version from</div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">OS Extraction</label>
                                <input type="text" class="form-control" name="os_extraction" placeholder="context.os.name">
                                <div class="help-text">Field to extract operating system from</div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Entry Point Extraction</label>
                                <input type="text" class="form-control" name="entry_point_extraction" placeholder="properties.entry_point">
                                <div class="help-text">Field to extract entry point from</div>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-12">
                                <label class="form-label">Filters</label>
                                <textarea class="form-control" name="filters" rows="3" placeholder="user_id is not null&#10;event is not null&#10;timestamp is not null"></textarea>
                                <div class="help-text">One filter condition per line (SQL WHERE clause)</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Authentication -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-key me-2"></i>
                            Authentication
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Authentication Method Tabs -->
                        <ul class="nav nav-tabs mb-3" id="authTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="sso-tab" data-bs-toggle="tab" data-bs-target="#sso" type="button" role="tab" aria-controls="sso" aria-selected="true">
                                    <i class="fas fa-user me-2"></i>
                                    SSO / Normal Credentials
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="service-account-tab" data-bs-toggle="tab" data-bs-target="#service-account" type="button" role="tab" aria-controls="service-account" aria-selected="false">
                                    <i class="fas fa-cog me-2"></i>
                                    Service Account
                                </button>
                            </li>
                        </ul>
                        
                        <!-- Tab Content -->
                        <div class="tab-content" id="authTabContent">
                            <!-- SSO / Normal Credentials Tab -->
                            <div class="tab-pane fade show active" id="sso" role="tabpanel" aria-labelledby="sso-tab">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <strong>SSO Authentication:</strong> Use your Google account credentials for authentication. 
                                    This method uses your default Google Cloud credentials (gcloud auth application-default login).
                                </div>
                                <div class="alert alert-warning">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    <strong>Prerequisites:</strong> Make sure you're logged into the correct Google account with access to the BigQuery project. 
                                    Run <code>gcloud auth application-default login</code> in your terminal if you haven't already.
                                </div>
                            </div>
                            
                            <!-- Service Account Tab -->
                            <div class="tab-pane fade" id="service-account" role="tabpanel" aria-labelledby="service-account-tab">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <strong>Service Account:</strong> Use a service account key for authentication. 
                                    Your credentials are used temporarily and are not stored.
                                </div>
                                <textarea 
                                    class="form-control" 
                                    name="gcp_credentials" 
                                    rows="8" 
                                    placeholder="Paste your GCP service account JSON credentials here..."
                                ></textarea>
                                <div class="help-text mt-2">
                                    <i class="fas fa-lightbulb me-1"></i>
                                    Get your service account key from 
                                    <a href="https://console.cloud.google.com/iam-admin/serviceaccounts" target="_blank" class="text-decoration-none">
                                        Google Cloud Console
                                    </a>
                                </div>
                                <div class="alert alert-warning mt-3">
                                    <i class="fas fa-shield-alt me-2"></i>
                                    <strong>Security:</strong> The service account should have BigQuery Data Editor and Job User roles for the project.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Loading Spinner -->
                <div class="loading text-center mb-3" id="loading">
                    <div class="spinner mb-2"></div>
                    <p class="text-muted">Creating configuration and running funnel analysis...</p>
                </div>

                <!-- Submit Button -->
                <div class="d-grid">
                    <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                        <i class="fas fa-rocket me-2"></i>
                        Create Configuration & Run Analysis
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        let stepCount = 0;
        
        // Handle authentication tab switching
        document.addEventListener('DOMContentLoaded', function() {
            const authTabs = document.querySelectorAll('#authTabs .nav-link');
            const authMethodField = document.getElementById('auth_method');
            
            authTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const target = this.getAttribute('data-bs-target');
                    if (target === '#sso') {
                        authMethodField.value = 'sso';
                    } else if (target === '#service-account') {
                        authMethodField.value = 'service_account';
                    }
                });
            });
        });
        
        function addStep() {
            stepCount++;
            document.getElementById('step_count').value = stepCount;
            
            const stepsContainer = document.getElementById('steps-container');
            const noStepsMessage = document.getElementById('no-steps-message');
            
            if (noStepsMessage) {
                noStepsMessage.style.display = 'none';
            }
            
            const stepHtml = `
                <div class="step-card" id="step-${stepCount}">
                    <div class="step-number">${stepCount}</div>
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">Screen Name <span class="required">*</span></label>
                            <input type="text" class="form-control" name="step_${stepCount}_screen_name" placeholder="e.g., Home Page" required>
                            <div class="help-text">Display name for this funnel step</div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Events <span class="required">*</span></label>
                            <input type="text" class="form-control" name="step_${stepCount}_events" placeholder="page_view,click" required>
                            <div class="help-text">Comma-separated list of events for this step</div>
                        </div>
                    </div>
                    <div class="text-end mt-3">
                        <button type="button" class="btn btn-danger btn-sm" onclick="removeStep(${stepCount})">
                            <i class="fas fa-trash me-1"></i>
                            Remove Step
                        </button>
                    </div>
                </div>
            `;
            
            stepsContainer.insertAdjacentHTML('beforeend', stepHtml);
        }
        
        function removeStep(stepNumber) {
            const stepElement = document.getElementById(`step-${stepNumber}`);
            stepElement.remove();
            
            // Reorder remaining steps
            const remainingSteps = document.querySelectorAll('.step-card');
            if (remainingSteps.length === 0) {
                document.getElementById('no-steps-message').style.display = 'block';
                document.getElementById('step_count').value = 0;
                stepCount = 0;
            } else {
                // Update step numbers and form field names
                remainingSteps.forEach((step, index) => {
                    const newStepNumber = index + 1;
                    const stepNumberElement = step.querySelector('.step-number');
                    stepNumberElement.textContent = newStepNumber;
                    
                    // Update form field names
                    const screenNameInput = step.querySelector('input[name^="step_"][name$="_screen_name"]');
                    const eventsInput = step.querySelector('input[name^="step_"][name$="_events"]');
                    const removeButton = step.querySelector('button[onclick^="removeStep"]');
                    
                    if (screenNameInput) {
                        screenNameInput.name = `step_${newStepNumber}_screen_name`;
                    }
                    if (eventsInput) {
                        eventsInput.name = `step_${newStepNumber}_events`;
                    }
                    if (removeButton) {
                        removeButton.onclick = () => removeStep(newStepNumber);
                    }
                    
                    step.id = `step-${newStepNumber}`;
                });
                
                stepCount = remainingSteps.length;
                document.getElementById('step_count').value = stepCount;
            }
        }
        
        function validateForm() {
            // Check if at least one step is added
            if (stepCount === 0) {
                alert('Please add at least one funnel step');
                return false;
            }
            
            // Validate authentication method
            const authMethod = document.getElementById('auth_method').value;
            
            if (authMethod === 'service_account') {
                const credentials = document.querySelector('textarea[name="gcp_credentials"]').value.trim();
                
                if (!credentials) {
                    alert('Please enter service account credentials');
                    return false;
                }
                
                try {
                    JSON.parse(credentials);
                } catch (e) {
                    alert('Please enter valid JSON for service account credentials');
                    return false;
                }
            }
            
            // Show loading
            document.getElementById('loading').style.display = 'block';
            document.getElementById('submitBtn').disabled = true;
            return true;
        }
    </script>
</body>
</html> 